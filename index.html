<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šèªè¨€å­¸ç¿’å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom radio button styles */
        .radio-btn-group input[type="radio"] {
            display: none;
        }
        .radio-btn-group label {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            background-color: #ffffff;
            border: 2px solid #e5e7eb;
            font-weight: 500;
        }
        .radio-btn-group input[type="radio"]:checked + label {
            background-image: linear-gradient(to right, #fb7185, #facc15);
            color: white;
            border-color: transparent;
            transform: scale(1.08);
            box-shadow: 0 8px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }
        /* Loader styles */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        .page-loader {
             width: 50px;
             height: 50px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .bg-dreamy {
            background-color: #6B7280;
            background-image: linear-gradient(180deg, #a3b0ff 0%, #6952e6 100%);
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .floating {
            animation: float 6s ease-in-out infinite;
        }
        .lang-tab {
            transition: all 0.2s ease-in-out;
        }
        .lang-tab.active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="bg-dreamy text-gray-800 relative min-h-screen">

    <!-- Background Decorations -->
    <div id="dreamy-world" class="absolute top-0 left-0 w-full h-full overflow-hidden z-0">
        <!-- Hearts -->
        <svg class="absolute top-1/4 left-10 w-12 h-12 text-white opacity-20 floating" style="animation-duration: 8s;" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
        </svg>
        <svg class="absolute bottom-1/4 right-10 w-16 h-16 text-white opacity-20 floating" style="animation-duration: 10s; animation-delay: -2s;" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
        </svg>

        <!-- Sparkles -->
        <svg class="absolute top-20 right-1/4 w-8 h-8 text-yellow-200 opacity-30 floating" style="animation-duration: 5s;" fill="currentColor" viewBox="0 0 20 20">
           <path d="M10 2.5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0V3.25A.75.75 0 0110 2.5zM10 13.5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5a.75.75 0 01.75-.75zM3.25 10a.75.75 0 01.75-.75h3.5a.75.75 0 010 1.5H4a.75.75 0 01-.75-.75zM12.75 10a.75.75 0 01.75-.75h3.5a.75.75 0 010 1.5h-3.5a.75.75 0 01-.75-.75zM6.22 6.22a.75.75 0 011.06 0l2.47 2.47a.75.75 0 01-1.06 1.06L6.22 7.28a.75.75 0 010-1.06zM11.25 12.22a.75.75 0 011.06 0l2.47 2.47a.75.75 0 01-1.06 1.06l-2.47-2.47a.75.75 0 010-1.06zM6.22 13.78a.75.75 0 010-1.06l2.47-2.47a.75.75 0 111.06 1.06l-2.47 2.47a.75.75 0 01-1.06 0zM12.22 8.75a.75.75 0 010-1.06l2.47-2.47a.75.75 0 111.06 1.06l-2.47 2.47a.75.75 0 01-1.06 0z"/>
        </svg>
    </div>


    <div class="container mx-auto p-4 md:p-8 max-w-5xl relative z-10">
        <!-- Language Switcher -->
        <div class="absolute top-4 right-4 md:top-6 md:right-8 z-20">
            <select id="language-switcher" class="bg-white border-2 border-blue-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                <option value="zh-Hant">ç¹é«”ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="vi">Tiáº¿ng Viá»‡t</option>
                <option value="ja">æ—¥æœ¬èª</option>
            </select>
        </div>

        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-white flex items-center justify-center space-x-4">
                <span>ğŸ’–</span>
                <span data-translate-key="pageTitle">å¤šèªè¨€å­¸ç¿’å¹³å°</span>
                <span>âœ¨</span>
            </h1>
            <p class="text-lg text-indigo-200 mt-2" data-translate-key="pageSubtitle">é–‹å§‹ä»Šå¤©çš„å­¸ç¿’å†’éšªå§ï¼</p>
        </header>

        <!-- Step 1: Selection Form -->
        <div class="bg-blue-900/10 backdrop-blur-md rounded-xl shadow-lg p-6 md:p-8 mb-8 border-2 border-white/20">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Age Selection -->
                <div>
                    <h3 class="font-semibold text-lg mb-3 text-white opacity-90" data-translate-key="ageTitle">1. é¸æ“‡å¹´é½¡</h3>
                    <div id="age-group" class="radio-btn-group grid grid-cols-3 gap-2">
                        <input type="radio" id="age-under-5" name="age" value="5æ­²ä»¥ä¸‹" checked><label for="age-under-5" class="block text-center rounded-lg p-3 text-sm" data-translate-key="age_under_5">5æ­²ä»¥ä¸‹</label>
                        <input type="radio" id="age-6-10" name="age" value="6-10æ­²"><label for="age-6-10" class="block text-center rounded-lg p-3 text-sm" data-translate-key="age_6_10">6-10æ­²</label>
                        <input type="radio" id="age-10-15" name="age" value="10-15æ­²"><label for="age-10-15" class="block text-center rounded-lg p-3 text-sm" data-translate-key="age_10_15">10-15æ­²</label>
                        <div class="grid grid-cols-2 col-span-3 gap-2">
                            <input type="radio" id="age-15-20" name="age" value="15-20æ­²"><label for="age-15-20" class="block text-center rounded-lg p-3 text-sm" data-translate-key="age_15_20">15-20æ­²</label>
                            <input type="radio" id="age-over-20" name="age" value="20æ­²ä»¥ä¸Š"><label for="age-over-20" class="block text-center rounded-lg p-3 text-sm" data-translate-key="age_over_20">20æ­²ä»¥ä¸Š</label>
                        </div>
                    </div>
                </div>
                <!-- Subject Selection -->
                <div>
                    <h3 class="font-semibold text-lg mb-3 text-white opacity-90" data-translate-key="subjectTitle">2. é¸æ“‡èª²ç¨‹é¡å‹</h3>
                    <div id="subject-group" class="radio-btn-group grid grid-cols-2 gap-2">
                        <input type="radio" id="subject-kids-en" name="subject" value="KidsEnglish" checked><label for="subject-kids-en" class="block text-center rounded-lg p-3 text-sm" data-translate-key="subjectKidsEn">å…’ç«¥è‹±æ–‡</label>
                        <input type="radio" id="subject-adult-en" name="subject" value="AdultEnglish"><label for="subject-adult-en" class="block text-center rounded-lg p-3 text-sm" data-translate-key="subjectAdultEn">æˆäººè‹±æ–‡</label>
                        <input type="radio" id="subject-sci" name="subject" value="Science"><label for="subject-sci" class="block text-center rounded-lg p-3 text-sm" data-translate-key="subjectSci">ç§‘å­¸</label>
                        <input type="radio" id="subject-math" name="subject" value="Math"><label for="subject-math" class="block text-center rounded-lg p-3 text-sm" data-translate-key="subjectMath">æ•¸å­¸</label>
                        <input type="radio" id="subject-hist" name="subject" value="History"><label for="subject-hist" class="block text-center rounded-lg p-3 text-sm" data-translate-key="subjectHist">æ­·å²</label>
                        <input type="radio" id="subject-geo" name="subject" value="Geography"><label for="subject-geo" class="block text-center rounded-lg p-3 text-sm" data-translate-key="subjectGeo">åœ°ç†</label>
                    </div>
                </div>
                <!-- Lesson Type Selection -->
                <div>
                    <h3 class="font-semibold text-lg mb-3 text-white opacity-90" data-translate-key="typeTitle">3. é¸æ“‡é¡å‹</h3>
                    <div id="type-group" class="radio-btn-group grid grid-cols-1 gap-2">
                        <input type="radio" id="type-course" name="lessonType" value="æ•™å­¸èª²ç¨‹" checked><label for="type-course" class="block text-center rounded-lg p-3 text-sm" data-translate-key="typeCourse">æ•™å­¸èª²ç¨‹</label>
                        <input type="radio" id="type-story" name="lessonType" value="å•Ÿç™¼æ•…äº‹"><label for="type-story" class="block text-center rounded-lg p-3 text-sm" data-translate-key="typeStory">å•Ÿç™¼æ•…äº‹</label>
                        <input type="radio" id="type-vocab" name="lessonType" value="5å€‹å­—å½™èˆ‡ä¾‹å¥"><label for="type-vocab" class="block text-center rounded-lg p-3 text-sm" data-translate-key="typeVocab">5å€‹å­—å½™èˆ‡ä¾‹å¥</label>
                        <input type="radio" id="type-qa" name="lessonType" value="AIæå•"><label for="type-qa" class="block text-center rounded-lg p-3 text-sm" data-translate-key="typeQA">AIæå•</label>
                        <input type="radio" id="type-podcast" name="lessonType" value="é›™äººåšå®¢"><label for="type-podcast" class="block text-center rounded-lg p-3 text-sm" data-translate-key="typePodcast">é›™äººåšå®¢</label>
                    </div>
                </div>
            </div>

            <!-- New Topic Selection Area -->
            <div id="topic-selection-area" class="mt-8 pt-6 border-t-2 border-dashed border-blue-200/50">
                 <h3 class="font-semibold text-lg mb-3 text-white opacity-90" data-translate-key="topicTitle">4. é¸æ“‡èª²ç¨‹ä¸»é¡Œ</h3>
                 <select id="topic-select" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 bg-white">
                 </select>
                 <div id="custom-topic-wrapper" class="hidden mt-4">
                     <input id="custom-topic-input" type="text" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="è«‹è¼¸å…¥è‡ªè¨‚ä¸»é¡Œ" data-translate-key="customTopicPlaceholder">
                 </div>
            </div>

            <div class="mt-8 text-center">
                <button id="generate-lesson-btn" type="button" class="w-full md:w-1/2 bg-gradient-to-r from-emerald-400 to-cyan-500 text-white font-bold py-3 px-6 rounded-lg hover:from-emerald-500 hover:to-cyan-600 focus:outline-none focus:ring-4 focus:ring-cyan-300 transition-all transform hover:scale-105 shadow-lg">
                    <span data-translate-key="generateLessonBtn">ğŸš€ ç”Ÿæˆèª²ç¨‹å…§å®¹</span>
                </button>
            </div>
        </div>

        <!-- Step 2: Results Area -->
        <div id="result-area">
             <div id="loading-indicator" class="hidden text-center py-8">
                <div class="mx-auto loader page-loader"></div>
                <p class="text-white font-medium mt-4 text-lg" data-translate-key="loadingText">AI Agent æ­£åœ¨ç”Ÿæˆèª²ç¨‹ï¼Œè«‹ç¨å€™...</p>
            </div>
            <div id="error-message" class="hidden mt-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
                <p class="font-bold" data-translate-key="errorTitle">ç™¼ç”ŸéŒ¯èª¤</p>
                <p id="error-text"></p>
            </div>
            <div id="lesson-container" class="space-y-6">
                <!-- Generated lesson pages will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="relative bg-white p-2 rounded-lg max-w-4xl w-full max-h-full">
            <button id="close-modal-btn" class="absolute -top-4 -right-4 bg-white rounded-full p-2 text-gray-700 hover:text-black z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <img id="modal-image" src="" class="max-w-full max-h-[85vh] object-contain mx-auto" alt="Enlarged lesson image">
        </div>
    </div>


    <script type="module">
        // --- Globals ---
        const API_KEY = ""; // Will be provided by the Canvas environment
        let currentLesson = null;
        let currentLang = 'zh-Hant';
        const generatedMedia = {}; // To store generated blobs and base64 data

        const topicsData = {
            'KidsEnglish': ['Animals', 'Family', 'Colors', 'Numbers', 'Food', 'Clothing', 'BodyParts', 'Weather', 'Feelings', 'School'],
            'AdultEnglish': ['BusinessMeetings', 'EmailWriting', 'JobInterviews', 'TravelEnglish', 'SmallTalk', 'Presentations', 'Negotiations', 'Marketing', 'Finance', 'Retail'],
            'Science': ['Plants', 'Animals', 'HumanBody', 'SolarSystem', 'Weather', 'WaterCycle', 'Dinosaurs', 'Magnets', 'FiveSenses', 'Seasons'],
            'Math': ['Counting', 'Addition', 'Subtraction', 'Shapes', 'Patterns', 'Measurement', 'Time', 'Money', 'ComparingNumbers', 'SimpleFractions'],
            'History': ['ChineseHistory', 'VietnameseHistory', 'AncientEgypt', 'AncientGreeceRome', 'Renaissance', 'AgeOfDiscovery', 'IndustrialRevolution', 'WWI', 'WWII', 'ModernTechHistory'],
            'Geography': ['WorldCapitals', 'FamousLandmarks', 'OceansContinents', 'MountainRanges', 'MajorRivers', 'Deserts', 'Rainforests', 'TectonicPlates', 'ClimateZones', 'HumanMigration']
        };

        // --- Translation Data ---
        const translations = {
            'zh-Hant': {
                pageTitle: 'å¤šèªè¨€å­¸ç¿’å¹³å°',
                pageSubtitle: 'é–‹å§‹ä»Šå¤©çš„å­¸ç¿’å†’éšªå§ï¼',
                ageTitle: '1. é¸æ“‡å¹´é½¡',
                age_under_5: '5æ­²ä»¥ä¸‹', age_6_10: '6-10æ­²', age_10_15: '10-15æ­²', age_15_20: '15-20æ­²', age_over_20: '20æ­²ä»¥ä¸Š',
                subjectTitle: '2. é¸æ“‡èª²ç¨‹é¡å‹',
                subjectKidsEn: 'å…’ç«¥è‹±æ–‡', subjectAdultEn: 'æˆäººè‹±æ–‡', subjectSci: 'ç§‘å­¸', subjectMath: 'æ•¸å­¸', subjectHist: 'æ­·å²', subjectGeo: 'åœ°ç†',
                typeTitle: '3. é¸æ“‡é¡å‹',
                typeCourse: 'æ•™å­¸èª²ç¨‹',
                typeStory: 'å•Ÿç™¼æ•…äº‹',
                typeVocab: '5å€‹å­—å½™èˆ‡ä¾‹å¥',
                typeQA: 'AIæå•',
                typePodcast: 'é›™äººåšå®¢',
                topicTitle: '4. é¸æ“‡èª²ç¨‹ä¸»é¡Œ',
                customTopicPlaceholder: 'è«‹è¼¸å…¥è‡ªè¨‚ä¸»é¡Œ',
                customTopicOption: 'è‡ªè¨‚ä¸»é¡Œ...',
                generateLessonBtn: 'ğŸš€ ç”Ÿæˆèª²ç¨‹å…§å®¹',
                loadingText: 'AI Agent æ­£åœ¨ç”Ÿæˆèª²ç¨‹ï¼Œè«‹ç¨å€™...',
                errorTitle: 'ç™¼ç”ŸéŒ¯èª¤',
                lessonPageTitle: 'ç¬¬ {pageNum} é : {pageType}',
                vocabTitle: 'é‡é»å­—å½™',
                vocabWord: 'å–®å­—',
                vocabPhonetic: 'éŸ³æ¨™',
                vocabTranslation: 'ç¿»è­¯',
                vocabExample: 'ä¾‹å¥',
                imagePlaceholder: 'é»æ“ŠæŒ‰éˆ•ç”Ÿæˆåœ–ç‰‡',
                generateImageBtn: 'ç”Ÿæˆåœ–åƒ',
                generateAudioBtnEn: 'ç”Ÿæˆè‹±æ–‡èªéŸ³',
                generateAudioBtnVi: 'ç”Ÿæˆè¶Šå—æ–‡èªéŸ³',
                generateAudioBtnZh: 'ç”Ÿæˆä¸­æ–‡èªéŸ³',
                generateAudioBtnJa: 'ç”Ÿæˆæ—¥èªèªéŸ³',
                downloadAudioBtn: 'ä¸‹è¼‰èªéŸ³ (WAV)',
                imageError: 'åœ–ç‰‡ç”Ÿæˆå¤±æ•—',
                audioError: 'èªéŸ³ç”Ÿæˆå¤±æ•—',
                lessonError: 'èª²ç¨‹ç”Ÿæˆå¤±æ•—: {message}',
                topics: {
                    'KidsEnglish': ['å‹•ç‰©', 'å®¶åº­', 'é¡è‰²', 'æ•¸å­—', 'é£Ÿç‰©', 'è¡£æœ', 'èº«é«”éƒ¨ä½', 'å¤©æ°£', 'æƒ…ç·’', 'å­¸æ ¡'],
                    'AdultEnglish': ['å•†å‹™æœƒè­°', 'éƒµä»¶å¯«ä½œ', 'å·¥ä½œé¢è©¦', 'æ—…éŠè‹±æ–‡', 'æ—¥å¸¸é–’èŠ', 'ç°¡å ±æŠ€å·§', 'å•†æ¥­è«‡åˆ¤', 'å¸‚å ´è¡ŒéŠ·', 'è²¡ç¶“è‹±æ–‡', 'é›¶å”®æ‡‰ç”¨'],
                    'Science': ['æ¤ç‰©', 'å‹•ç‰©', 'äººé«”', 'å¤ªé™½ç³»', 'å¤©æ°£', 'æ°´å¾ªç’°', 'æé¾', 'ç£éµ', 'äº”ç¨®æ„Ÿå®˜', 'å­£ç¯€'],
                    'Math': ['æ•¸æ•¸', 'åŠ æ³•', 'æ¸›æ³•', 'å½¢ç‹€', 'è¦å¾‹', 'æ¸¬é‡', 'æ™‚é–“', 'é‡‘éŒ¢', 'æ•¸å­—æ¯”è¼ƒ', 'ç°¡å–®åˆ†æ•¸'],
                    'History': ['ä¸­åœ‹æ­·å²', 'è¶Šå—æ­·å²', 'å¤åŸƒåŠæ–‡æ˜', 'å¤å¸Œè‡˜ç¾…é¦¬', 'æ–‡è—å¾©èˆˆ', 'å¤§èˆªæµ·æ™‚ä»£', 'å·¥æ¥­é©å‘½', 'ç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ°', 'ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ°', 'ç¾ä»£ç§‘æŠ€å²'],
                    'Geography': ['ä¸–ç•Œé¦–éƒ½', 'è‘—ååœ°æ¨™', 'æµ·æ´‹èˆ‡å¤§é™¸', 'ä¸»è¦å±±è„ˆ', 'ä¸–ç•Œä¸»è¦æ²³æµ', 'ä¸–ç•Œæ²™æ¼ ', 'ç†±å¸¶é›¨æ—', 'æ¿å¡Šæ§‹é€ ', 'æ°£å€™å¸¶', 'äººé¡é·å¾™']
                }
            },
            'en': {
                pageTitle: 'Multilingual Learning Platform',
                pageSubtitle: "Let's start today's learning adventure!",
                ageTitle: '1. Select Age',
                age_under_5: 'Under 5', age_6_10: '6-10 years', age_10_15: '10-15 years', age_15_20: '15-20 years', age_over_20: 'Over 20',
                subjectTitle: '2. Select Course Type',
                subjectKidsEn: "Kids' English", subjectAdultEn: "Adult English", subjectSci: 'Science', subjectMath: 'Math', subjectHist: 'History', subjectGeo: 'Geography',
                typeTitle: '3. Select Type',
                typeCourse: 'Teaching Course',
                typeStory: 'Inspirational Story',
                typeVocab: '5 Vocab & Sentences',
                typeQA: 'AI Questions',
                typePodcast: 'Dual-host Podcast',
                topicTitle: '4. Select Course Topic',
                customTopicPlaceholder: 'Enter custom topic',
                customTopicOption: 'Custom Topic...',
                generateLessonBtn: 'ğŸš€ Generate Lesson Content',
                loadingText: 'AI Agent is generating the course, please wait...',
                errorTitle: 'An Error Occurred',
                lessonPageTitle: 'Page {pageNum}: {pageType}',
                vocabTitle: 'Key Vocabulary',
                vocabWord: 'Word',
                vocabPhonetic: 'Phonetic',
                vocabTranslation: 'Translation',
                vocabExample: 'Example',
                imagePlaceholder: 'Click button to generate image',
                generateImageBtn: 'Generate Image',
                generateAudioBtnEn: 'Generate English Audio',
                generateAudioBtnVi: 'Generate Vietnamese Audio',
                generateAudioBtnZh: 'Generate Chinese Audio',
                generateAudioBtnJa: 'Generate Japanese Audio',
                downloadAudioBtn: 'Download Audio (WAV)',
                imageError: 'Image generation failed',
                audioError: 'Audio generation failed',
                lessonError: 'Failed to generate lesson: {message}',
                topics: {
                    'KidsEnglish': topicsData.KidsEnglish,
                    'AdultEnglish': ['Business Meetings', 'Email Writing', 'Job Interviews', 'Travel English', 'Small Talk', 'Presentations', 'Negotiations', 'Marketing', 'Finance', 'Retail'],
                    'Science': topicsData.Science,
                    'Math': topicsData.Math,
                    'History': ['Chinese History', 'Vietnamese History', 'Ancient Egypt', 'Ancient Greece & Rome', 'The Renaissance', 'Age of Discovery', 'Industrial Revolution', 'World War I', 'World War II', 'History of Modern Tech'],
                    'Geography': ['World Capitals', 'Famous Landmarks', 'Oceans & Continents', 'Mountain Ranges', 'Major Rivers', 'Deserts', 'Rainforests', 'Tectonic Plates', 'Climate Zones', 'Human Migration']
                }
            },
            'vi': {
                pageTitle: 'Ná»n táº£ng há»c táº­p Ä‘a ngÃ´n ngá»¯',
                pageSubtitle: 'HÃ£y báº¯t Ä‘áº§u cuá»™c phiÃªu lÆ°u há»c táº­p hÃ´m nay!',
                ageTitle: '1. Chá»n Ä‘á»™ tuá»•i',
                age_under_5: 'DÆ°á»›i 5 tuá»•i', age_6_10: '6-10 tuá»•i', age_10_15: '10-15 tuá»•i', age_15_20: '15-20 tuá»•i', age_over_20: 'TrÃªn 20 tuá»•i',
                subjectTitle: '2. Chá»n loáº¡i khÃ³a há»c',
                subjectKidsEn: 'Tiáº¿ng Anh tráº» em', subjectAdultEn: 'Tiáº¿ng Anh ngÆ°á»i lá»›n', subjectSci: 'Khoa há»c', subjectMath: 'ToÃ¡n há»c', subjectHist: 'Lá»‹ch sá»­', subjectGeo: 'Äá»‹a lÃ½',
                typeTitle: '3. Chá»n loáº¡i',
                typeCourse: 'BÃ i giáº£ng',
                typeStory: 'CÃ¢u chuyá»‡n truyá»n cáº£m há»©ng',
                typeVocab: '5 tá»« vá»±ng & cÃ¢u vÃ­ dá»¥',
                typeQA: 'CÃ¢u há»i AI',
                typePodcast: 'Podcast hai ngÆ°á»i',
                topicTitle: '4. Chá»n chá»§ Ä‘á» khÃ³a há»c',
                customTopicPlaceholder: 'Nháº­p chá»§ Ä‘á» tÃ¹y chá»‰nh',
                customTopicOption: 'Chá»§ Ä‘á» tÃ¹y chá»‰nh...',
                generateLessonBtn: 'ğŸš€ Táº¡o ná»™i dung khÃ³a há»c',
                loadingText: 'AI Agent Ä‘ang táº¡o khÃ³a há»c, vui lÃ²ng Ä‘á»£i...',
                errorTitle: 'ÄÃ£ xáº£y ra lá»—i',
                lessonPageTitle: 'Trang {pageNum}: {pageType}',
                vocabTitle: 'Tá»« vá»±ng chÃ­nh',
                vocabWord: 'Tá»«',
                vocabPhonetic: 'PhiÃªn Ã¢m',
                vocabTranslation: 'Báº£n dá»‹ch',
                vocabExample: 'VÃ­ dá»¥',
                imagePlaceholder: 'Nháº¥p vÃ o nÃºt Ä‘á»ƒ táº¡o hÃ¬nh áº£nh',
                generateImageBtn: 'Táº¡o hÃ¬nh áº£nh',
                generateAudioBtnEn: 'Táº¡o Ã¢m thanh Tiáº¿ng Anh',
                generateAudioBtnVi: 'Táº¡o Ã¢m thanh Tiáº¿ng Viá»‡t',
                generateAudioBtnZh: 'Táº¡o Ã¢m thanh Tiáº¿ng Trung',
                generateAudioBtnJa: 'Táº¡o Ã¢m thanh Tiáº¿ng Nháº­t',
                downloadAudioBtn: 'Táº£i Ã¢m thanh (WAV)',
                imageError: 'Táº¡o hÃ¬nh áº£nh tháº¥t báº¡i',
                audioError: 'Táº¡o Ã¢m thanh tháº¥t báº¡i',
                lessonError: 'KhÃ´ng thá»ƒ táº¡o bÃ i há»c: {message}',
                topics: {
                    'KidsEnglish': ['Äá»™ng váº­t', 'Gia Ä‘Ã¬nh', 'MÃ u sáº¯c', 'Con sá»‘', 'Thá»©c Äƒn', 'Quáº§n Ã¡o', 'CÃ¡c bá»™ pháº­n cÆ¡ thá»ƒ', 'Thá»i tiáº¿t', 'Cáº£m xÃºc', 'TrÆ°á»ng há»c'],
                    'AdultEnglish': ['Há»p kinh doanh', 'Viáº¿t email', 'Phá»ng váº¥n xin viá»‡c', 'Tiáº¿ng Anh du lá»‹ch', 'NÃ³i chuyá»‡n phiáº¿m', 'Thuyáº¿t trÃ¬nh', 'ÄÃ m phÃ¡n', 'Tiáº¿p thá»‹', 'TÃ i chÃ­nh', 'BÃ¡n láº»'],
                    'Science': ['Thá»±c váº­t', 'Äá»™ng váº­t', 'CÆ¡ thá»ƒ ngÆ°á»i', 'Há»‡ máº·t trá»i', 'Thá»i tiáº¿t', 'VÃ²ng tuáº§n hoÃ n nÆ°á»›c', 'Khá»§ng long', 'Nam chÃ¢m', 'NÄƒm giÃ¡c quan', 'CÃ¡c mÃ¹a'],
                    'Math': ['Äáº¿m', 'PhÃ©p cá»™ng', 'PhÃ©p trá»«', 'HÃ¬nh dáº¡ng', 'Máº«u', 'Äo lÆ°á»ng', 'Thá»i gian', 'Tiá»n báº¡c', 'So sÃ¡nh sá»‘', 'PhÃ¢n sá»‘ Ä‘Æ¡n giáº£n'],
                    'History': ['Lá»‹ch sá»­ Trung Quá»‘c', 'Lá»‹ch sá»­ Viá»‡t Nam', 'VÄƒn minh Ai Cáº­p cá»• Ä‘áº¡i', 'Hy Láº¡p vÃ  La MÃ£ cá»• Ä‘áº¡i', 'Phá»¥c hÆ°ng', 'Thá»i Ä‘áº¡i khÃ¡m phÃ¡', 'CÃ¡ch máº¡ng cÃ´ng nghiá»‡p', 'Tháº¿ chiáº¿n thá»© nháº¥t', 'Tháº¿ chiáº¿n thá»© hai', 'Lá»‹ch sá»­ cÃ´ng nghá»‡ hiá»‡n Ä‘áº¡i'],
                    'Geography': ['Thá»§ Ä‘Ã´ tháº¿ giá»›i', 'Äá»‹a danh ná»•i tiáº¿ng', 'Äáº¡i dÆ°Æ¡ng vÃ  Lá»¥c Ä‘á»‹a', 'DÃ£y nÃºi', 'SÃ´ng lá»›n', 'Sa máº¡c', 'Rá»«ng nhiá»‡t Ä‘á»›i', 'Máº£ng kiáº¿n táº¡o', 'VÃ¹ng khÃ­ háº­u', 'Di cÆ° cá»§a con ngÆ°á»i']
                }
            },
            'ja': {
                pageTitle: 'å¤šè¨€èªå­¦ç¿’ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ',
                pageSubtitle: 'ä»Šæ—¥ã®å­¦ç¿’å†’é™ºã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼',
                ageTitle: '1. å¹´é½¢ã‚’é¸æŠ',
                age_under_5: '5æ­³ä»¥ä¸‹', age_6_10: '6-10æ­³', age_10_15: '10-15æ­³', age_15_20: '15-20æ­³', age_over_20: '20æ­³ä»¥ä¸Š',
                subjectTitle: '2. ã‚³ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ',
                subjectKidsEn: 'å­ä¾›å‘ã‘è‹±èª', subjectAdultEn: 'å¤§äººå‘ã‘è‹±èª', subjectSci: 'ç§‘å­¦', subjectMath: 'æ•°å­¦', subjectHist: 'æ­´å²', subjectGeo: 'åœ°ç†',
                typeTitle: '3. ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ',
                typeCourse: 'æ•™è‚²ã‚³ãƒ¼ã‚¹',
                typeStory: 'æ„Ÿå‹•çš„ãªç‰©èª',
                typeVocab: '5ã¤ã®èªå½™ã¨ä¾‹æ–‡',
                typeQA: 'AIã‹ã‚‰ã®è³ªå•',
                typePodcast: 'äºŒäººå¯¾è«‡ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ',
                topicTitle: '4. ã‚³ãƒ¼ã‚¹ãƒˆãƒ”ãƒƒã‚¯ã‚’é¸æŠ',
                customTopicPlaceholder: 'ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›',
                customTopicOption: 'ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ”ãƒƒã‚¯...',
                generateLessonBtn: 'ğŸš€ ãƒ¬ãƒƒã‚¹ãƒ³å†…å®¹ã‚’ç”Ÿæˆ',
                loadingText: 'AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚³ãƒ¼ã‚¹ã‚’ç”Ÿæˆä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...',
                errorTitle: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
                lessonPageTitle: 'ãƒšãƒ¼ã‚¸ {pageNum}: {pageType}',
                vocabTitle: 'é‡è¦èªå½™',
                vocabWord: 'å˜èª',
                vocabPhonetic: 'ç™ºéŸ³è¨˜å·',
                vocabTranslation: 'ç¿»è¨³',
                vocabExample: 'ä¾‹æ–‡',
                imagePlaceholder: 'ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’ç”Ÿæˆ',
                generateImageBtn: 'ç”»åƒã‚’ç”Ÿæˆ',
                generateAudioBtnEn: 'è‹±èªã®éŸ³å£°ã‚’ç”Ÿæˆ',
                generateAudioBtnVi: 'ãƒ™ãƒˆãƒŠãƒ èªã®éŸ³å£°ã‚’ç”Ÿæˆ',
                generateAudioBtnZh: 'ä¸­å›½èªã®éŸ³å£°ã‚’ç”Ÿæˆ',
                generateAudioBtnJa: 'æ—¥æœ¬èªã®éŸ³å£°ã‚’ç”Ÿæˆ',
                downloadAudioBtn: 'éŸ³å£°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (WAV)',
                imageError: 'ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ',
                audioError: 'éŸ³å£°ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ',
                lessonError: 'ãƒ¬ãƒƒã‚¹ãƒ³ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: {message}',
                topics: {
                    'KidsEnglish': ['å‹•ç‰©', 'å®¶æ—', 'è‰²', 'æ•°å­—', 'é£Ÿã¹ç‰©', 'æœ', 'ä½“ã®éƒ¨ä½', 'å¤©æ°—', 'æ„Ÿæƒ…', 'å­¦æ ¡'],
                    'AdultEnglish': ['ãƒ“ã‚¸ãƒã‚¹ä¼šè­°', 'ãƒ¡ãƒ¼ãƒ«ä½œæˆ', 'å°±è·ã®é¢æ¥', 'æ—…è¡Œè‹±ä¼šè©±', 'ä¸–é–“è©±', 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³', 'äº¤æ¸‰', 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°', 'é‡‘è', 'å°å£²'],
                    'Science': ['æ¤ç‰©', 'å‹•ç‰©', 'äººä½“', 'å¤ªé™½ç³»', 'å¤©æ°—', 'æ°´ã®å¾ªç’°', 'æç«œ', 'ç£çŸ³', 'äº”æ„Ÿ', 'å­£ç¯€'],
                    'Math': ['æ•°ãˆã‚‹ã“ã¨', 'è¶³ã—ç®—', 'å¼•ãç®—', 'å½¢', 'ãƒ‘ã‚¿ãƒ¼ãƒ³', 'æ¸¬å®š', 'æ™‚é–“', 'ãŠé‡‘', 'æ•°å­—ã®æ¯”è¼ƒ', 'ç°¡å˜ãªåˆ†æ•°'],
                    'History': ['ä¸­å›½ã®æ­´å²', 'ãƒ™ãƒˆãƒŠãƒ ã®æ­´å²', 'å¤ä»£ã‚¨ã‚¸ãƒ—ãƒˆæ–‡æ˜', 'å¤ä»£ã‚®ãƒªã‚·ãƒ£ãƒ»ãƒ­ãƒ¼ãƒ', 'ãƒ«ãƒã‚µãƒ³ã‚¹', 'å¤§èˆªæµ·æ™‚ä»£', 'ç”£æ¥­é©å‘½', 'ç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ¦', 'ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ¦', 'ç¾ä»£æŠ€è¡“å²'],
                    'Geography': ['ä¸–ç•Œã®é¦–éƒ½', 'æœ‰åãªãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯', 'æµ·æ´‹ã¨å¤§é™¸', 'å±±è„ˆ', 'ä¸»è¦ãªå·', 'ç ‚æ¼ ', 'ç†±å¸¯é›¨æ—', 'æ§‹é€ ãƒ—ãƒ¬ãƒ¼ãƒˆ', 'æ°—å€™å¸¯', 'äººé¡ã®ç§»å‹•']
                }
            }
        };

        // --- DOM Elements ---
        const generateLessonBtn = document.getElementById('generate-lesson-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const lessonContainer = document.getElementById('lesson-container');
        const languageSwitcher = document.getElementById('language-switcher');
        const subjectGroup = document.getElementById('subject-group');
        const topicSelect = document.getElementById('topic-select');
        const customTopicWrapper = document.getElementById('custom-topic-wrapper');
        const customTopicInput = document.getElementById('custom-topic-input');
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const closeModalBtn = document.getElementById('close-modal-btn');
        
        // --- Event Listeners ---
        generateLessonBtn.addEventListener('click', handleGenerateLesson);
        languageSwitcher.addEventListener('change', (event) => setLanguage(event.target.value));
        subjectGroup.addEventListener('change', (event) => {
            if(event.target.name === 'subject'){
                updateTopicSelection(event.target.value);
            }
        });
        topicSelect.addEventListener('change', (event) => {
            customTopicWrapper.classList.toggle('hidden', event.target.value !== 'custom');
        });
        closeModalBtn.addEventListener('click', closeModal);
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                closeModal();
            }
        });

        // --- Modal Functions ---
        function openModal(imageUrl) {
            modalImage.src = imageUrl;
            imageModal.classList.remove('hidden');
        }

        function closeModal() {
            imageModal.classList.add('hidden');
            modalImage.src = ''; 
        }

        // --- Translation & UI Update Functions ---
        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                const translation = translations[lang][key];
                if (translation) {
                     if (el.placeholder) {
                        el.placeholder = translation;
                    } else {
                        const span = el.querySelector('span');
                        if (span) {
                            span.innerHTML = translation;
                        } else {
                            el.innerHTML = translation;
                        }
                    }
                }
            });
            updateTopicSelection(document.querySelector('input[name="subject"]:checked').value);
            if (currentLesson) {
                renderLesson();
            }
        }

        function updateTopicSelection(subject) {
            const t = translations[currentLang];
            const subjectTopics = t.topics[subject];
            
            topicSelect.innerHTML = '';
            subjectTopics.forEach(topicText => {
                const option = document.createElement('option');
                option.value = topicText;
                option.textContent = topicText;
                topicSelect.appendChild(option);
            });
            const customOption = document.createElement('option');
            customOption.value = 'custom';
            customOption.textContent = t.customTopicOption;
            topicSelect.appendChild(customOption);
            customTopicWrapper.classList.add('hidden');
        }


        // --- Core Functions ---
        async function handleGenerateLesson() {
            const age = document.querySelector('input[name="age"]:checked').value;
            let topic = topicSelect.value;
            if (topic === 'custom') {
                topic = customTopicInput.value;
            }
            if (!topic) {
                showError("è«‹é¸æ“‡æˆ–è¼¸å…¥ä¸€å€‹èª²ç¨‹ä¸»é¡Œã€‚");
                return;
            }
            const lessonType = document.querySelector('input[name="lessonType"]:checked').value;
            const prompt = `ç‚ºä¸€å€‹å¹´é½¡ä»‹æ–¼ã€Œ${age}ã€çš„å­¸ç¿’è€…, ç”Ÿæˆä¸€å€‹é—œæ–¼ã€Œ${topic}ã€çš„ã€Œ${lessonType}ã€ã€‚èª²ç¨‹å…§å®¹è«‹å‹™å¿…åŒæ™‚æä¾›è‹±æ–‡ã€è¶Šå—æ–‡ã€ç¹é«”ä¸­æ–‡ã€ä»¥åŠæ—¥æ–‡çš„ç¿»è­¯ã€‚`;
            
            setLoading(true);
            hideError();
            lessonContainer.innerHTML = '';
            currentLesson = null;
            Object.keys(generatedMedia).forEach(key => delete generatedMedia[key]);

            try {
                const systemPrompt = `You are a multilingual educational content generator. Your task is to create content based on user specifications.

                User will specify: 1. Age Range 2. Topic 3. Lesson Type.
                
                Lesson Types:
                1. "æ•™å­¸èª²ç¨‹" (Teaching Course): Create a 3-5 page lesson plan (intro, activity, outro).
                2. "å•Ÿç™¼æ•…äº‹" (Inspirational Story): Create a single-page short story.
                3. "5å€‹å­—å½™èˆ‡ä¾‹å¥" (5 Vocab & Sentences): Create a single page with 5 vocab words and example sentences.
                4. "AIæå•" (AI Questions): Create a single page with 3-5 questions about the topic.
                5. "é›™äººåšå®¢" (Dual-host Podcast): Create a single-page podcast script with two hosts (Host A, Host B) discussing the topic.

                Output JSON Structure:
                {
                  "lesson_id": "auto_generated_uuid", "child_age_range": "<age_range_string>", "theme": "<topic>", "languages": ["EN", "VI", "ZH-TW", "JA"], "lesson_type": "<type>",
                  "pages": [
                    {
                      "page_number": 1, "type": "...",
                      "text": {"EN": "...", "VI": "...", "ZH-TW": "...", "JA": "..."},
                      "image_prompt": "...",
                      "vocabulary": [
                        { 
                          "word": "example", "phonetic": "/ÉªÉ¡ËˆzÃ¦mpÉ™l/", 
                          "translation": { "VI": "vÃ­ dá»¥", "ZH-TW": "ä¾‹å­", "JA": "ä¾‹" },
                          "example_sentence": { "EN": "...", "VI": "...", "ZH-TW": "...", "JA": "..." }
                        }
                      ]
                    }
                  ]
                }
                CRITICAL RULES:
                - Adjust content complexity based on the age range. For '20æ­²ä»¥ä¸Š', use adult-level concepts.
                - For each page, select 5 key English words from the 'text.EN' content.
                - In the 'text.EN' string, wrap these 5 words in <b> tags.
                - Populate the 'vocabulary' array with these 5 words, including phonetic (IPA), translations (VI, ZH-TW, JA), and an example_sentence object with sentences in all 4 languages.
                - For the "é›™äººåšå®¢" type, format the text with "Host A:" and "Host B:" prefixes.
                - The entire response MUST be a single, valid JSON object without markdown.`;

                const lessonJsonText = await callGenerativeAPI(systemPrompt, prompt, "application/json");
                currentLesson = JSON.parse(lessonJsonText);
                renderLesson();

            } catch (err) {
                console.error("Lesson Generation Error:", err);
                const errorMsg = translations[currentLang].lessonError.replace('{message}', err.message);
                showError(errorMsg);
            } finally {
                setLoading(false);
            }
        }
        
        function createVocabularyHtmlForLang(vocabulary, lang) {
            if (!vocabulary || vocabulary.length === 0) return '';
            const t = translations[currentLang];
            const langMap = {'EN': 'EN', 'VI': 'VI', 'ZH-TW': 'ZH-TW', 'JA': 'JA'};
            const targetLang = langMap[lang];

            const vocabItemsHtml = vocabulary.map(item => `
                <div class="py-2">
                    <div class="flex items-baseline">
                        <strong class="text-indigo-600 mr-2">${item.word}</strong>
                        <span class="text-gray-500">${item.phonetic}</span>
                    </div>
                    <div class="text-sm text-gray-700 ml-2">
                        <p><strong class="font-medium">${t.vocabTranslation}:</strong> ${item.translation[targetLang]}</p>
                        <p><strong class="font-medium">${t.vocabExample}:</strong> ${item.example_sentence[targetLang]}</p>
                    </div>
                </div>
            `).join('');

            return `
                <div class="mt-6 pt-4 border-t border-dashed border-blue-200">
                    <h4 class="font-semibold text-base mb-2 text-indigo-700">${t.vocabTitle}</h4>
                    <div>${vocabItemsHtml}</div>
                </div>
            `;
        }


        function renderLesson() {
            if (!currentLesson || !currentLesson.pages) return;
            const t = translations[currentLang];
            
            const pagesHtml = currentLesson.pages.map((page, index) => {
                const pageTitle = t.lessonPageTitle.replace('{pageNum}', page.page_number).replace('{pageType}', page.type);
                
                return `
                <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl border-2 border-white">
                    <div class="flex justify-between items-center mb-4">
                         <h3 class="text-xl font-bold text-blue-700">${pageTitle}</h3>
                         <span class="text-sm bg-yellow-200 text-yellow-800 font-medium px-3 py-1 rounded-full">${currentLesson.theme}</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Text Content with Tabs -->
                        <div>
                            <div class="border-b border-gray-200">
                                <nav id="lang-tabs-${index}" class="-mb-px flex space-x-4" aria-label="Tabs">
                                    <button data-lang="EN" class="lang-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 active">English</button>
                                    <button data-lang="VI" class="lang-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Tiáº¿ng Viá»‡t</button>
                                    <button data-lang="ZH-TW" class="lang-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">ç¹é«”ä¸­æ–‡</button>
                                    <button data-lang="JA" class="lang-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">æ—¥æœ¬èª</button>
                                </nav>
                            </div>
                            <div id="lang-content-${index}" class="prose max-w-none py-4">
                                <div data-lang-panel="EN" class=""><p>${page.text.EN}</p>${createVocabularyHtmlForLang(page.vocabulary, 'EN')}</div>
                                <div data-lang-panel="VI" class="hidden"><p>${page.text.VI}</p>${createVocabularyHtmlForLang(page.vocabulary, 'VI')}</div>
                                <div data-lang-panel="ZH-TW" class="hidden"><p>${page.text['ZH-TW']}</p>${createVocabularyHtmlForLang(page.vocabulary, 'ZH-TW')}</div>
                                <div data-lang-panel="JA" class="hidden"><p>${page.text.JA || ''}</p>${createVocabularyHtmlForLang(page.vocabulary, 'JA')}</div>
                            </div>
                        </div>


                        <!-- Media Generation -->
                        <div class="space-y-4">
                             <div id="image-container-${index}" class="w-full aspect-video bg-gray-100 rounded-lg flex items-center justify-center text-gray-400">
                                <span data-translate-key="imagePlaceholder">${t.imagePlaceholder}</span>
                             </div>
                             <div id="image-controls-${index}" class="flex gap-2">
                                <button type="button" class="generate-image-btn flex-grow py-2 px-4 bg-gradient-to-r from-pink-500 to-orange-400 text-white rounded-lg hover:from-pink-600 hover:to-orange-500" data-index="${index}" data-translate-key="generateImageBtn">${t.generateImageBtn}</button>
                             </div>
                             
                             <div id="audio-container-${index}" class="mt-4 space-y-2"></div>
                             <div id="audio-controls-${index}" class="grid grid-cols-2 lg:grid-cols-4 gap-2">
                                <button type="button" class="generate-audio-btn py-2 px-4 bg-sky-500 text-white rounded-lg hover:bg-sky-600 text-sm" data-index="${index}" data-lang="EN" data-translate-key="generateAudioBtnEn">${t.generateAudioBtnEn}</button>
                                <button type="button" class="generate-audio-btn py-2 px-4 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 text-sm" data-index="${index}" data-lang="VI" data-translate-key="generateAudioBtnVi">${t.generateAudioBtnVi}</button>
                                <button type="button" class="generate-audio-btn py-2 px-4 bg-violet-500 text-white rounded-lg hover:bg-violet-600 text-sm" data-index="${index}" data-lang="ZH-TW" data-translate-key="generateAudioBtnZh">${t.generateAudioBtnZh}</button>
                                <button type="button" class="generate-audio-btn py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm" data-index="${index}" data-lang="JA" data-translate-key="generateAudioBtnJa">${t.generateAudioBtnJa}</button>
                             </div>
                        </div>
                    </div>
                </div>
            `}).join('');
            lessonContainer.innerHTML = pagesHtml;
            
            document.querySelectorAll('.generate-image-btn').forEach(btn => btn.addEventListener('click', handleGenerateImage));
            document.querySelectorAll('.generate-audio-btn').forEach(btn => btn.addEventListener('click', handleGenerateAudio));

            // Setup tab functionality for each lesson page
            currentLesson.pages.forEach((page, index) => {
                const tabContainer = document.getElementById(`lang-tabs-${index}`);
                const contentContainer = document.getElementById(`lang-content-${index}`);
                if (tabContainer && contentContainer) {
                    tabContainer.addEventListener('click', (event) => {
                        if (event.target.matches('.lang-tab')) {
                            const lang = event.target.dataset.lang;
                            
                            // Update tabs
                            tabContainer.querySelectorAll('.lang-tab').forEach(tab => {
                                tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
                                tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                            });
                            event.target.classList.add('active', 'border-blue-500', 'text-blue-600');
                            event.target.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                            // Update content
                            contentContainer.querySelectorAll('[data-lang-panel]').forEach(panel => {
                                panel.classList.toggle('hidden', panel.dataset.langPanel !== lang);
                            });
                        }
                    });
                    // Activate the first tab by default
                    const firstTab = tabContainer.querySelector('.lang-tab[data-lang="EN"]');
                    if (firstTab) firstTab.click();
                }
            });
        }

       async function handleGenerateImage(event) {
            const index = event.target.dataset.index;
            const page = currentLesson.pages[index];
            const container = document.getElementById(`image-container-${index}`);
            const controls = document.getElementById(`image-controls-${index}`);
            const button = event.target;

            button.disabled = true;
            container.innerHTML = `<div class="loader"></div>`;

            try {
                const base64Data = await callImageAPI(page.image_prompt);
                const imageUrl = `data:image/png;base64,${base64Data}`;
                generatedMedia[`image-${index}`] = imageUrl;

                const imgElement = document.createElement('img');
                imgElement.src = imageUrl;
                imgElement.className = "rounded-lg object-contain w-full h-full cursor-pointer";
                imgElement.alt = `Generated image for ${currentLesson.theme}`;
                imgElement.addEventListener('click', () => openModal(imageUrl));

                container.innerHTML = '';
                container.appendChild(imgElement);
                
                if (controls) {
                    controls.innerHTML = '';
                }

            } catch (err) {
                console.error("Image Generation Error:", err);
                container.innerHTML = `<span class="text-red-500">${err.message}</span>`;
                button.disabled = false;
            }
        }

        function getVoiceConfigForAge(age) {
            switch(age) {
                case '5æ­²ä»¥ä¸‹':
                    return { voiceName: 'Leda', promptPrefix: 'Say in a cheerful, friendly, and slightly slower voice:' };
                case '6-10æ­²':
                    return { voiceName: 'Callirrhoe', promptPrefix: 'Say in an encouraging and clear voice:' };
                case '10-15æ­²':
                     return { voiceName: 'Aoede', promptPrefix: 'Say clearly:' };
                case '15-20æ­²':
                    return { voiceName: 'Kore', promptPrefix: 'Say in an informative tone:' };
                case '20æ­²ä»¥ä¸Š':
                    return { voiceName: 'Orus', promptPrefix: 'Say in a professional tone:' };
                default:
                    return { voiceName: 'Kore', promptPrefix: 'Say clearly:' };
            }
        }


        async function handleGenerateAudio(event) {
            const index = event.target.dataset.index;
            const lang = event.target.dataset.lang;
            const page = currentLesson.pages[index];
            const container = document.getElementById(`audio-container-${index}`);
            const button = event.target;
            
            const originalText = button.textContent;
            button.disabled = true;
            button.innerHTML = `<div class="loader mx-auto" style="width:20px; height:20px; border-width:2px;"></div>`;
            
            try {
                const textToSpeak = page.text[lang];
                if (!textToSpeak) throw new Error(`No text found for language: ${lang}`);
                
                let payload;
                const lessonType = currentLesson.lesson_type;
                const age = currentLesson.child_age_range;

                if (lessonType === 'é›™äººåšå®¢' || lessonType === 'Dual-host Podcast' || lessonType === 'Podcast hai ngÆ°á»i' || lessonType === 'äºŒäººå¯¾è«‡ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ') {
                     payload = {
                        contents: [{
                            parts: [{ text: `TTS the following conversation: \n${textToSpeak}` }]
                        }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                multiSpeakerVoiceConfig: {
                                    speakerVoiceConfigs: [
                                        { speaker: "Host A", voiceConfig: { prebuiltVoiceConfig: { voiceName: "Orus" } } }, // Male-sounding
                                        { speaker: "Host B", voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }  // Female-sounding
                                    ]
                                }
                            }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    };
                } else {
                    const { voiceName, promptPrefix } = getVoiceConfigForAge(age);
                    payload = {
                      contents: [{ parts: [{ text: `${promptPrefix} ${textToSpeak}` }] }],
                      generationConfig: { 
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                           voiceConfig: {
                               prebuiltVoiceConfig: { voiceName: voiceName }
                           }
                        }
                      }, 
                      model: "gemini-2.5-flash-preview-tts"
                    };
                }
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.error?.message || `API Error: ${response.statusText}`);
                }
                
                const result = await response.json();
                const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (!audioData) throw new Error("No audio data returned");
                
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, 24000);
                const audioUrl = URL.createObjectURL(wavBlob);
                const mediaKey = `audio-${index}-${lang}`;
                generatedMedia[mediaKey] = audioUrl;
                
                if (container) {
                    const existingPlayer = container.querySelector(`[data-lang="${lang}"]`);
                    if(existingPlayer) existingPlayer.remove();

                    const playerWrapper = document.createElement('div');
                    playerWrapper.className = 'flex items-center gap-2';
                    playerWrapper.dataset.lang = lang;
                    
                    const audioEl = new Audio(audioUrl);
                    audioEl.controls = true;
                    audioEl.className = 'w-full';

                    const downloadBtn = document.createElement('button');
                    downloadBtn.type = 'button';
                    downloadBtn.className = "download-audio-btn p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600";
                    downloadBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                                  <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                  <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg>`;
                    downloadBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        downloadMedia(mediaKey, `${currentLesson.theme}-p${page.page_number}-${lang}.wav`);
                    });

                    playerWrapper.appendChild(audioEl);
                    playerWrapper.appendChild(downloadBtn);
                    container.appendChild(playerWrapper);
                }

            } catch (err) {
                console.error("Audio Generation Error:", err);
                if (container) {
                    const errorPara = document.createElement('p');
                    errorPara.className = 'text-red-500 text-sm';
                    errorPara.textContent = `${lang}: ${err.message}`;
                    container.appendChild(errorPara);
                }
            } finally {
                 button.disabled = false;
                 button.innerHTML = originalText;
            }
        }
        
        function downloadMedia(mediaKey, filename) {
            const mediaUrl = generatedMedia[mediaKey];
            if (!mediaUrl) {
                console.error("Media not found for key:", mediaKey);
                return;
            }
            const a = document.createElement('a');
            a.href = mediaUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- API Call Helpers ---
        async function callGenerativeAPI(systemPrompt, userPrompt, responseMimeType = "text/plain") {
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
             const payload = { systemInstruction: { parts: [{ text: systemPrompt }] }, contents: [{ parts: [{ text: userPrompt }] }], generationConfig: { responseMimeType } };
             const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
             if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error?.message || "API request failed"); }
             const result = await response.json();
             return result.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        async function callImageAPI(prompt) {
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;
             const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
             const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
             if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(errorData?.error?.message || `API Error: ${response.statusText}`);
             }
             const result = await response.json();
             const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
             if (!base64Data) {
                console.error("Image API Response issue:", result);
                throw new Error("No image data returned from API.");
             }
             return base64Data;
        }

        // --- UI Helpers ---
        function setLoading(isLoading) {
            loadingIndicator.classList.toggle('hidden', !isLoading);
            generateLessonBtn.disabled = isLoading;
            generateLessonBtn.classList.toggle('opacity-50', isLoading);
        }

        function showError(message) { errorText.textContent = message; errorMessage.classList.remove('hidden'); }
        function hideError() { errorMessage.classList.add('hidden'); }
        
        // --- Audio Conversion Helpers ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            const numChannels = 1, bitsPerSample = 16, blockAlign = (numChannels * bitsPerSample) / 8;
            const byteRate = sampleRate * blockAlign, dataSize = pcmData.length * 2;
            view.setUint32(0, 0x52494646, false); // "RIFF"
            view.setUint32(4, 36 + dataSize, true);
            view.setUint32(8, 0x57415645, false); // "WAVE"
            view.setUint32(12, 0x666d7420, false); // "fmt "
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true); view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true); view.setUint16(34, bitsPerSample, true);
            view.setUint32(36, 0x64617461, false); // "data"
            view.setUint32(40, dataSize, true);
            const wavBytes = new Uint8Array(44 + dataSize);
            wavBytes.set(new Uint8Array(header), 0);
            wavBytes.set(new Uint8Array(pcmData.buffer), 44);
            return new Blob([wavBytes], { type: 'audio/wav' });
        }
        
        // --- Initial Load ---
        function createBubbles() {
            const container = document.getElementById('underwater-world');
            if (!container) return;
            const bubbleCount = 20;
            for (let i = 0; i < bubbleCount; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                const size = Math.random() * 40 + 10; // 10px to 50px
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                bubble.style.left = `${Math.random() * 100}%`;
                bubble.style.animationDuration = `${Math.random() * 10 + 8}s`; // 8s to 18s
                bubble.style.animationDelay = `${Math.random() * 5}s`;
                container.appendChild(bubble);
            }
        }
        
        setLanguage(currentLang);
        createBubbles();

    </script>
</body>
</html>

